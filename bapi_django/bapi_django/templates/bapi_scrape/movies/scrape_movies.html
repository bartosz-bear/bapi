{% extends "base.html" %}   // Inherits all the components from base template, including the header and footer

{% block main %}

<main>

    <div class="reading">

        <h2 id="movies-swap">Scraping movies</h2><br>

        <p>'best_movies' crawler, scraping from live <a href='https://www.imdb.com/search/title/?groups=top_250&sort=user_rating' target="_blank" rel="noopener">www.imdb.com</a>. Crawler visits 'Top 250 best movies of all times' ranking which is split into 5 pages, 50 movies each.
          Crawler visits 5 paginated pages first, collecting 250 urls to individual movie pages.
           </p>

           <div class="box">

           {% load static %}
           <img src="{% static 'bapi_scrape/best_movies.png' %}" class="box.img" alt="Best movies"><br><br>

          </div><br>

           <p>Then the crawler proceeds to visit each movie's URL and scrap detailed data about each movie.</p>

           <div class="box">

           {% load static %}
           <img src="{% static 'bapi_scrape/best_movies_ind.png' %}" class="box.img" alt="Best movies"><br><br>
         
          </div><br>

           <p>Data is saved to SQL database and it can be viewed in the Expose section: <a href='/expose/expose_best_movies/'>Scraped movies data</a><br><br></p>
           

           <h2>Crawler code</h2>

           <p>Below you can see the code for the crawler. Alternatively you can see in the GitHub repo.</p>

        <pre><code class="language-python">
import scrapy
from scrapy.linkextractors import LinkExtractor
from scrapy.spiders import CrawlSpider, Rule

from bapi_scrape.scrapy.imdb.imdb.items import ImdbItem

class BestMoviesSpider(CrawlSpider):
    name = 'best_movies'
    allowed_domains = ['www.imdb.com']

    user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)
     Chrome/111.0.0.0 Safari/537.36'

    custom_settings = {'ITEM_PIPELINES': {
        'imdb.pipelines.ImdbPipeline': 300
    }}

    def start_requests(self):
        yield scrapy.Request(
                      url='https://www.imdb.com/search/title/?groups=top_250&sort=user_rating',
                      headers={'User-Agent': self.user_agent})

    rules = (
        Rule(LinkExtractor(restrict_xpaths="//h3[@class='lister-item-header']/a"),
        callback='parse_item', follow=True, process_request='set_user_agent'),
        Rule(LinkExtractor(restrict_xpaths="(//a[@class='lister-page-next next-page'])[2]"),
        process_request='set_user_agent')
    )

    def set_user_agent(self, request, spider):
        request.headers['User-Agent'] = self.user_agent
        return request

    def parse_item(self, response):
        
        container = response.xpath("//div[@class='ipc-page-content-container
         ipc-page-content-container--center'][2]")

        title = container.xpath(".//section/section/div[2]/div/h1/span/text()").get()
        if not title:
          title = container.xpath(".//section/section/div[2]/div/h1/text()").get()

        year = container.xpath(".//section/section/div[2]/div/ul/li/a/text()").get()
        if not year:
          year = container.xpath(".//section/section/div[2]/div/div//ul/li/a/text()").get()

        duration = container.xpath(".//section/section/div[2]/div/ul/li[3]/text()").get()
        if not duration:
          duration = container.xpath(".//section/section/div[2]/div/div/ul/li[3]/text()").extract()
          del duration[2]
          duration = ' '.join(duration)

        genre = container.xpath(".//section/section/div[3]/div[2]/div/section/div/div[2]/a[1]/span/
        text()").get()
        if not genre:
          genre = container.xpath(".//section/section/div[3]/div[2]/div/div/div/div/a/span/text()")
          .get()

        rating = container.xpath(".//section/section/div[3]/div[2]/div/div/div//div[2]/div/span/
        text()").get()

        imdb_item = ImdbItem()

        imdb_item['title'] = title
        imdb_item['year'] = year
        imdb_item['duration'] = duration
        imdb_item['genre'] = genre
        imdb_item['rating'] = rating
        imdb_item['movie_url'] = response.url

        yield imdb_item

        </code></pre>

    </div>

</main>

{% load static %}

<script src="https://unpkg.com/htmx.org@1.8.6"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
<script>hljs.highlightAll();</script>


{% endblock %}

{% block style %}

<style>
  body {
    background: white;
  }
  .box {
    width: 100%;
    height: 100%;
    border: 1px solid white;
    display: flex;
    justify-content: center;
  }
  img {
    width: 80%;
    height: 100%;
    margin: 0 auto;
  }

  .table {
    table-layout:fixed;
  }

  .table th {
    color: white;
  }

  .table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  div.reading {
    width: 800px;
    margin: 0 auto;
  }

  #myProgress {
    width: 100%;
    background-color: #ddd;
  }

  #myBar {
    width: 1%;
    height: 30px;
    background-color: #04AA6D;
  }
</style>

{% endblock %}
